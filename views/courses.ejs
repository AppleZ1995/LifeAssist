<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Courses Management</title>
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background-color: #f5f5f5;
      }
      .card {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .loading {
        display: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">LifeAssist</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item">
              <a class="nav-link active" href="/courses">Courses</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-5">
      <div class="row mb-4">
        <div class="col-md-8">
          <h1>ðŸ“š Courses Management</h1>
        </div>
        <div class="col-md-4 text-end">
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addCourseModal"
          >
            + Add New Course
          </button>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div id="loading" class="text-center loading">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Courses Table -->
      <div class="card">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Instructor</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="coursesTable">
              <tr>
                <td colspan="5" class="text-center text-muted">
                  No courses found. Add one to get started!
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination"></ul>
      </nav>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="addCourseModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Course</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="courseForm">
              <div class="mb-3">
                <label class="form-label">Course Title *</label>
                <input type="text" class="form-control" name="title" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  name="description"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Instructor</label>
                <input type="text" class="form-control" name="instructor" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveCourse()"
            >
              Save Course
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Course Modal -->
    <div class="modal fade" id="editCourseModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Course</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editCourseForm">
              <input type="hidden" name="id" />
              <div class="mb-3">
                <label class="form-label">Course Title *</label>
                <input type="text" class="form-control" name="title" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  name="description"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Instructor</label>
                <input type="text" class="form-control" name="instructor" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateCourse()"
            >
              Update Course
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentPage = 1;
      const perPage = 5;

      // Load courses on page load
      document.addEventListener("DOMContentLoaded", () => loadCourses());

      function loadCourses(page = 1) {
        currentPage = page;
        showLoading(true);

        fetch(`/api/v1/courses?per_page=${perPage}&page=${page}`)
          .then((res) => res.json())
          .then((data) => {
            displayCourses(data.data);
            displayPagination(data.pagination);
            showLoading(false);
          })
          .catch((err) => {
            console.error("Error loading courses:", err);
            showLoading(false);
            alert("Error loading courses");
          });
      }

      function displayCourses(courses) {
        const tbody = document.getElementById("coursesTable");
        if (!courses || courses.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">No courses found.</td></tr>';
          return;
        }

        tbody.innerHTML = courses
          .map(
            (course) => `
                <tr>
                    <td><strong>${course.id}</strong></td>
                    <td>${course.title}</td>
                    <td>${course.description || "-"}</td>
                    <td>${course.instructor || "-"}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editCourse(${
                          course.id
                        })">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCourse(${
                          course.id
                        })">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      function displayPagination(pagination) {
        const paginationDiv = document.getElementById("pagination");
        const totalPages = Math.ceil(pagination.total / pagination.per_page);
        let html = "";

        if (pagination.page > 1) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCourses(${
            pagination.page - 1
          })">Previous</a></li>`;
        }

        for (let i = 1; i <= totalPages; i++) {
          html += `<li class="page-item ${
            i === pagination.page ? "active" : ""
          }">
                    <a class="page-link" href="#" onclick="loadCourses(${i})">${i}</a>
                </li>`;
        }

        if (pagination.page < totalPages) {
          html += `<li class="page-item"><a class="page-link" href="#" onclick="loadCourses(${
            pagination.page + 1
          })">Next</a></li>`;
        }

        paginationDiv.innerHTML = html;
      }

      function saveCourse() {
        const form = document.getElementById("courseForm");
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        fetch("/api/v1/courses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
            } else {
              alert("Course added successfully!");
              form.reset();
              bootstrap.Modal.getInstance(
                document.getElementById("addCourseModal")
              ).hide();
              loadCourses(1);
            }
          })
          .catch((err) => alert("Error saving course: " + err));
      }

      function editCourse(id) {
        fetch(`/api/v1/courses/${id}`)
          .then((res) => res.json())
          .then((course) => {
            document.querySelector('#editCourseForm input[name="id"]').value =
              course.id;
            document.querySelector(
              '#editCourseForm input[name="title"]'
            ).value = course.title;
            document.querySelector(
              '#editCourseForm textarea[name="description"]'
            ).value = course.description || "";
            document.querySelector(
              '#editCourseForm input[name="instructor"]'
            ).value = course.instructor || "";
            new bootstrap.Modal(
              document.getElementById("editCourseModal")
            ).show();
          })
          .catch((err) => alert("Error loading course: " + err));
      }

      function updateCourse() {
        const form = document.getElementById("editCourseForm");
        const formData = new FormData(form);
        const id = formData.get("id");
        const data = {
          title: formData.get("title"),
          description: formData.get("description"),
          instructor: formData.get("instructor"),
        };

        fetch(`/api/v1/courses/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
            } else {
              alert("Course updated successfully!");
              bootstrap.Modal.getInstance(
                document.getElementById("editCourseModal")
              ).hide();
              loadCourses(currentPage);
            }
          })
          .catch((err) => alert("Error updating course: " + err));
      }

      function deleteCourse(id) {
        if (confirm("Are you sure you want to delete this course?")) {
          fetch(`/api/v1/courses/${id}`, { method: "DELETE" })
            .then((res) => res.json())
            .then((data) => {
              if (data.error) {
                alert("Error: " + data.error);
              } else {
                alert("Course deleted successfully!");
                loadCourses(currentPage);
              }
            })
            .catch((err) => alert("Error deleting course: " + err));
        }
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }
    </script>
  </body>
</html>
